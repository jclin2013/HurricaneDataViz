<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">

    <title>Hurricane Data Visualization</title>

    <script src="https://use.fontawesome.com/edb8528b4a.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/2.4.1/lodash.min.js"></script>
    <script>
      _u = _.noConflict();
    </script>
    <script src="./d3.js"></script>

    <script src="./dataset.js"></script>
    <script src="./yearRangeBucketizer.js"></script>
    <script src="./createTrendlinesLegend.js"></script>
    <script src="./createInputs.js"></script>

    <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="style.css">
  </head>
  <body>
    <svg id="mainSVG">
    </svg>
    <script>
      let originalDataset = _u.merge([], dataset);
      let w = 750, h = 450;
      let p = {bottom: 75, right: 50, top: 80, left: 70};

      let svg = d3.select("#mainSVG")
                  .attr("width", w)
                  .attr("height", h);

      createTrendlinesLegend(svg, w, h, p);
      createInputs(svg, h, p);

      let xScale = d3.scaleBand()
                     .domain(d3.range(1851, 2017))
                     .range([p.left, w - p.right])
                     .paddingInner(0.05);

      let allHurricanes = d => d.cat1 + d.cat2 + d.cat3 + d.cat4 + d.cat5;

      let yScale = d3.scaleLinear()
                     .domain([
                       d3.min(dataset, d => allHurricanes(d)),
                       d3.max(dataset, d => allHurricanes(d)) + 1
                     ])
                     .range([h - p.bottom, p.top]);

      let fiveTicksForXAxis = domain => {
        return domain.filter((v, i) => {
          return !(i % (Math.floor(domain.length/5)))
        });
      };

      let xAxis = d3.axisBottom(xScale)
                    .tickValues(fiveTicksForXAxis(xScale.domain()))
                    .tickSizeInner(10)
                    .tickSizeOuter(0);

      let yAxis = d3.axisLeft(yScale)
                    .tickSizeOuter(0)
                    .ticks(6)
                    .tickFormat(d3.format("d"));

      let gx = svg.append("g")
                  .attr("class", "x axis")
                  .attr("transform", "translate(0.5," + (h - p.bottom) + ")")
                  .call(xAxis);

      let gy = svg.append("g")
                  .attr("class", "y axis")
                  .attr("transform", "translate(" + p.left + ", 0)")
                  .call(yAxis);

      let makeHorizGridLines = d3.axisLeft(yScale)
                                 .tickSize(-w + p.left + p.right)
                                 .tickFormat("")
                                 .ticks(6)
                                 .tickSizeOuter(0);

      let gridX = svg.append("g")
                     .attr("class", "grid x")
                     .attr("transform", "translate(" + p.left + ", 0)")
                     .call(makeHorizGridLines);

      svg.selectAll(".tick")
          .filter(d => d === 0)
          .remove();

      let title = svg.append("text")
                     .attr("class", "chartTitle")
                     .attr("width", w)
                     .attr("height", h * 0.2)
                     .attr("x", w/2)
                     .attr("y", 60/2)
                     .text("Number of Hurricanes Striking America Over Time")
                     .attr("text-anchor", "middle")
                     .attr("font-size", "20")
                     .attr("text-decoration", "underline");

       //y axis label
       svg.append("text")
           .attr("transform", "rotate(-90)")
           .attr("y", p.left/2)
           .attr("x", -h/2)
           .style("text-anchor", "middle")
           .text("Number of Hurricanes")

      let barGroups = svg.selectAll("g.barGroups")
                         .data(dataset, d => d.key)
                         .enter()
                         .append("g")
                         .attr("class", "barGroups");

      barGroups.append("rect")
               .attr("class", "bar allcatbars")
               .attr("x", d => xScale(d.year) + 1)
               .attr("y", d => yScale(allHurricanes(d)))
               .attr("height", d => h - p.bottom - yScale(allHurricanes(d)))
               .attr("width", xScale.bandwidth())
               .attr("fill", "#9fc49f");

       let majorHurricanes = d => d.cat3 + d.cat4 + d.cat5;

       let middleOfBigBar = d => (
         xScale(d.year) + (xScale.bandwidth() - xScale.bandwidth()/2.5)/2 + 1
       );

       barGroups.append("rect")
                .attr("class", "bar majorcatbars")
                .attr("x", middleOfBigBar)
                .attr("y", d => yScale(majorHurricanes(d)))
                .attr("height", d => h - p.bottom - yScale(majorHurricanes(d)))
                .attr("width", xScale.bandwidth()/2.5)
                .attr("fill", "pink");

        document.querySelector("#intervalInput")
                .onkeypress = e => { if (e.key === "Enter") changeHandler(); };

        d3.select("#submitIntervalButton")
          .on("click", changeHandler);

        d3.select("#check")
          .on("change", function() { changeHandler(this.checked) } );

        function changeHandler(isCheckboxChecked) {
            let interval = +document.querySelector("#intervalInput").value;

            if (typeof isCheckboxChecked !== "undefined") {
              let lastObj = originalDataset[originalDataset.length - 1];

              if (lastObj.year === 2017) {
                originalDataset.pop();
              } else {
                originalDataset.push({
                  year: 2017,
                  cat1: 0,
                  cat2: 0,
                  cat3: 0,
                  cat4: 3,
                  cat5: 0,
                  key: "2017-interval1"
                });
              }
            }

            dataset = yearRangeBucketizer(originalDataset, interval);

            console.log(dataset);

            //update the xAxis
            xScale.domain(dataset.map(obj => obj.year))
                  .paddingInner(0.05);

            gx.transition().duration(500).call(
              xAxis.scale(xScale)
                   .tickSizeInner(10)
                   .tickValues(fiveTicksForXAxis(xScale.domain()))
            );

            //update the yAxis
            yScale.domain([
              0,
              d3.max(dataset, d => allHurricanes(d)) + 1
            ]);

            gy.transition().duration(500).call(
              yAxis.scale(yScale)
                   .ticks(6)
            );

            //update the gridlines
            makeHorizGridLines.scale(yScale)
                              .ticks(6);

            gridX.transition().duration(500).call(makeHorizGridLines);

            //update the bars
            let groupsNewBind = svg.selectAll(".barGroups")
                                   .data(dataset, d => d.key);

            let enterGroups = groupsNewBind.enter()
                                           .append("g")
                                           .attr("class", "barGroups");

            enterGroups.append("rect")
                       .attr("class", "bar allcatbars")
                       .attr("x", d => xScale(d.year) + 1)
                       .attr("y", h - p.bottom)
                       .attr("height", 0)
                       .attr("width", xScale.bandwidth())
                       .attr("fill", "#9fc49f");

            enterGroups.append("rect")
                       .attr("class", "bar majorcatbars")
                       .attr("x", middleOfBigBar)
                       .attr("y", h - p.bottom)
                       .attr("height", 0)
                       .attr("width", xScale.bandwidth()/2.5)
                       .attr("fill", "pink");

            let updateSelection = enterGroups.merge(groupsNewBind);

            updateSelection.selectAll(".allcatbars")
                           .transition()
                           .duration(500)
                           .attr("height", d => h - p.bottom - yScale(allHurricanes(d)))
                           .attr("y", d => yScale(allHurricanes(d)))
                           .attr("x", d => xScale(d.year) + 1);

           updateSelection.selectAll(".majorcatbars")
                          .transition()
                          .duration(500)
                          .attr("height", d => h - p.bottom - yScale(majorHurricanes(d)))
                          .attr("y", d => yScale(majorHurricanes(d)))
                          .attr("x", middleOfBigBar);

            groupsNewBind.exit().remove();
        }
    </script>
  </body>
</html>
